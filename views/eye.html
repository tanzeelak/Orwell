<!DOCTYPE html>
<html>


<head>
    <meta charset="utf-8">
    <title>Orwell: Eyeball</title>
    <style>
        body {
            margin: 0;
        }

        canvas {
            width: 100%;
            height: 100%
        }

        video,
        videocanvas {
            position: absolute;
        }
    </style>
</head>

<body>

    <canvas id="myCanvas"></canvas>
    <div>
        <canvas id="videocanvas" width="320" height="240"></canvas>
        <video id="video" width="320" height="240" preload autoplay loop muted></video>
    </div>

    <script type="text/javascript" src="/node_modules/tracking/build/tracking-min.js"></script>
    <script type="text/javascript" src="/node_modules/tracking/build/data/face-min.js"></script>
    <script type="text/javascript" src="/node_modules/dat.gui/build/dat.gui.min.js"></script>
    <script type="text/javascript" src="/node_modules/tracking/examples/assets/stats.min.js"></script>
    <script type="text/javascript" src="/public/js/main.js"></script>
    <script src="/node_modules/three/build/three.min.js"></script>

    <script>
        var renderer,
            scene,
            camera,
            myCanvas = document.getElementById('myCanvas');

        var eye_ball_mesh, lower_lid_mesh, upper_lid_mesh;

        function init() {
            document.addEventListener('mousemove', onMouseMove, false);
            window.addEventListener('resize', onWindowResize, false);
        }

        //RENDERER
        renderer = new THREE.WebGLRenderer({
            canvas: myCanvas,
            antialias: true
        });
        //renderer.setClearColor(0x140b33, 1);
        renderer.setClearColor(0x000000);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);

        //CAMERA
        camera = new THREE.PerspectiveCamera(35, window.innerWidth / window.innerHeight, 0.1, 1000);

        //SCENE
        scene = new THREE.Scene();

        //LIGHTS
        var light = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(light);

        var light2 = new THREE.PointLight(0xffffff, 0.5);
        scene.add(light2);

        var loader = new THREE.JSONLoader();
        var texture = new THREE.TextureLoader().load('/assets/neweye.jpg');
        var material = new THREE.MeshBasicMaterial({ map: texture })
        var material_eye_lid = new THREE.MeshPhongMaterial({ color: 0x303030/*, flatShading: true*/});
        loader.load('/assets/eye_ball.json', eye_ball);
        loader.load('/assets/upper_lid.json', upper_lid);
        loader.load('/assets/lower_lid.json', lower_lid);

        function lower_lid(geometry, materials) {
            lower_lid_mesh = new THREE.Mesh(geometry, material_eye_lid);
            scene.add(lower_lid_mesh);
            lower_lid_mesh.position.z = -10;
            lower_lid_mesh.scale.set(.5, .5, .5);       //change the size of the eye using the scale.set() function
        }

        function upper_lid(geometry, materials) {
            upper_lid_mesh = new THREE.Mesh(geometry, material_eye_lid);
            scene.add(upper_lid_mesh);
            upper_lid_mesh.position.z = -10;
            upper_lid_mesh.scale.set(.5, .5, .5);
        }

        function eye_ball(geometry, materials) {
            eye_ball_mesh = new THREE.Mesh(geometry, material);
            scene.add(eye_ball_mesh);
            eye_ball_mesh.position.z = -10;
            eye_ball_mesh.scale.set(.5, .5, .5);
        }

        var globalX = 0;
        var globalY = 0;
        var MaxXRot = 1;
        var MaxYRot = -1;
        var upper_flag = 0;

        var animate = function () {
            requestAnimationFrame(animate);

            if (upper_lid_mesh.rotation.x < -0.04) {
                upper_flag = 0;
            }
            else if (upper_lid_mesh.rotation.x > 1) {
                upper_flag = 1;
            }
            if (!upper_flag) {
                upper_lid_mesh.rotation.x += 0.015;
            }
            else {
                upper_lid_mesh.rotation.x -= 0.015;
            }

            eye_ball_mesh.rotation.y = -(((globalX - 160) / 160) * MaxXRot);
            eye_ball_mesh.rotation.x = -(((globalY - 120) / 120) * MaxYRot);

            renderer.render(scene, camera);
        };

        window.onload = function () {
            var video = document.getElementById('video');
            var canvas = document.getElementById('videocanvas');
            var context = canvas.getContext('2d');

            var tracker = new tracking.ObjectTracker('face');
            tracker.setInitialScale(4);
            tracker.setStepSize(2);
            tracker.setEdgesDensity(0.1);

            tracking.track(video, tracker, { camera: true });

            tracker.on("track", function (event) {
                event.data.forEach(function (rect) {
                    if (Math.abs(globalX - rect.x) > 10 || Math.abs(globalY - rect.y) > 10) {
                        animate();
                    }

                    globalX = rect.x + (rect.width / 2);
                    globalY = rect.y + (rect.height / 2);
                });
            });

            var gui = new dat.GUI();
            gui.add(tracker, "edgesDensity", 0.1, 0.5).step(0.01);
            gui.add(tracker, "initialScale", 1.0, 10.0).step(0.1);
            gui.add(tracker, "stepSize", 1, 5).step(0.1);
        }

    </script>
</body>

</html>